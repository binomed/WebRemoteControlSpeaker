<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../mixins/helpers/dispatcher-mixin.html">


<dom-module id="remote-header">
  <template>

	<!-- Styles MUST be inside template -->
	<style>

		:host {
			display: block;
			position: relative;
			overflow: hidden;
		}


		app-toolbar {
			background-color: var(--bg-color-abs);
			color: #fff;
		}


		.elapsed {
			position:relative;
			text-align: center;
			color: var(--font-color-timer);
			vertical-align:middle;
			
		}



		.elapsed_time, .elapsed_bg{
			background: linear-gradient(top, var(--color-normal-stop-1), var(--color-normal-stop-2) no-repeat;    
			position: absolute;    
			border-top: thin solid var(--color-actions);
			height:var(--margin-timer);
			width:100%;
			left:0;
		}

		.elapsed_bg{
			background-image: none;
			background-color: white;
		}

		.elapsed_time.alert{
			background: linear-gradient(top, var(--color-alert-stop-1), var(--color-alert-stop-2) no-repeat;
		}
		.elapsed_time.advanced{
			background: linear-gradient(top, var(--color-advanced-stop-1), var(--color-advanced-stop-2) no-repeat;
		}

		.timeEllapesd{
			font-weight: 400;
			font-size: var(--font-size-timer);
			color:var(--font-color-timer);
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;    
			text-align: center;
		}

		.totalTime{
			font-weight: 400;
			font-size: var(--font-size-slide-number);
			color:var(--font-color-mute);
			
		}

		.elapsed .mute {
			color: var(--font-color-mute);
		}

		.actions_times{
			position: absolute;
			background-color:var(--bg-color-abs);
			top:0;
			right:var(--abs-height);
			height:var(--abs-height);
			width:var(--abs-height);
		}

		#action_time_play, #action_time_pause{
			position:absolute;
			border-left : thin solid var(--color-actions);
			border-right : thin solid var(--color-actions);
			top: 0;
			width:var(--abs-height);
			height:var(--abs-height);    
			text-align:center;
			color:var(--color-actions);
			
		}


	</style>

	<app-toolbar>
		<paper-icon-button icon="menu" on-tap="_drawerLeft"></paper-icon-button>
		<div main-title id="ellapsedTime">
			<div class="elapsed" ng-show="showTime">
				<div class="timeEllapesd">
					<span  id="hours" ng-class="classHours" hidden$="[[!showHours]]">[[hours]] : </span><span id="minutes" class="classMinutes">[[minutes]]</span><span
						id="seconds"> : [[seconds]]</span><span class="totalTime">&nbsp;/&nbsp;[[defaultInterval]]:00</span>
				</div>
			</div>
			<!--<div class="elapsed_bg">
			</div>
			<div id="progress_elapsed_time" class="elapsed_time">
			</div>-->
		</div>
		<paper-icon-button icon="extension" on-tap="_drawerRight"></paper-icon-button>
	</app-toolbar>
</template>

<script>

// Extend Polymer.Element base class
class RemoteHeader extends DispatcherMixin(Polymer.Element) {

	static get is() { return 'remote-header' }

	static get config() {
		// properties, observers meta data
		return {
			properties: {
				hours: {
					type: String,
					value: '00'
				},
				minutes: {
					type: String,
					value: '00'
				},
				seconds: {
					type: String,
					value: '00'
				},
				runningTimer: {
					type: Boolean,
					value: false,
					observer: '_manageTimer'
				},
				now: Date,

				showHours: {
					type: Boolean,
					value: false
				},
				muteMinutes: {
					type: Boolean,
					value: true
				},
				classMinutes: {
					type: String,
					value: 'mute'
				},
				totalTime : { // Total time ellapsed during the presentation
					type: Number,
					value: 0
				},
				defaultInterval : { // Time in minute of the conference
					type: Number, 
					value: 60
				}

			}

		};
	}

	connectedCallback() {
		super.connectedCallback();

		this.now = moment();
		setInterval( _ => {
			if (this.runningTimer){
				let diff = moment().diff(this.now) + this.totalTime;

				this._manageTimerState(diff);
			}
		}, 500);

		/*this.querySelector('paper-icon-button').addEventListener('tap', function() {
			this.dispatchEvent(new CustomEvent('menu-open'), {bubbles: true});
		});*/
	}

	attributeChangedCallback(){
		console.log('attributeChangedCallback');
	}
	attributeChanged(){
		console.log('attributeChanged');
	}

	toggleTimer(event){
		this.runningTimer = !event.detail.playState;		
	}

	resetTimer(){
		this.runningTimer = false;
		this._updateTotalTime(0);
		this._manageTimerState(0);
	}

	_manageTimerState(diff){
		const hoursDiff = Math.floor(diff / (60 * 60 * 1000));
		const minutesDiff = Math.floor(diff / (60 * 1000));
		const secondsDiff = Math.floor(diff % (60 * 1000) / 1000);

		this.hours = new Intl.NumberFormat('fr', {minimumIntegerDigits:2, useGrouping: false}).format(hoursDiff);
		this.minutes = new Intl.NumberFormat('fr', {minimumIntegerDigits:2, useGrouping: false}).format(minutesDiff);
		this.seconds= new Intl.NumberFormat('fr', {minimumIntegerDigits:2, useGrouping: false}).format(secondsDiff);

		if (hoursDiff > 0 && !this.showHours){
			this.showHours = true;
		}else if (hoursDiff === 0 && this.showHours){
			this.showHours = false;
		}

		if (minutesDiff > 0 && this.muteMinutes){
			this.muteMinutes = false;
			this.classMinutes = '';
		}else if (minutesDiff === 0 && !this.muteMinutes){
			this.muteMinutes = false;
			this.classMinutes = 'mute';
		}
	}

	_manageTimer(playState){
		if (!playState){
			this._updateTotalTime(this.totalTime + moment().diff(this.now));
		}else{
			this.now = moment();
		}
	}

	_updateTotalTime(time){
		this.dispatchAction('update-time', {totalTime: time});
	}

	_drawerLeft(){
		this.dispatchAction('toggle-drawer', {direction: 'left'});
	}

	_drawerRight(){
		this.dispatchAction('toggle-drawer', {direction: 'right'});
	}

}

// Register custom element definition using standard platform API
customElements.define(RemoteHeader.is, RemoteHeader);

</script>
</dom-module>