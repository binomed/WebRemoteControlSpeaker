<link rel="import" href="../helpers/event-bus-mixin.html">

<script>
	class ModelTimer {
		constructor() {
			this.runningTimer = false;
			this.defaultInterval = 60;
			this.limitAlert = 1;
			this.totalTime = 0;
			this.now = null;

		}
	}

	const TimerModelMixin = subclass => class extends EventBusMixin(subclass) {

		static get config() {
			// properties, observers meta data
			return {
				properties: {
					runningTimer: { // True if the timer is running
						type: Boolean,
						value: false
					},
					defaultInterval: { // Time in minute of the conference
						type: Number,
						value: 60
					},
					limitAlert: { // time before the end where we have to alert the speaker (if defaultInterval is upper limitAlert)
						type: Number,
						value: 1
					},
					totalTime: { // Total time ellapsed during the presentation
						type: Number,
						value: 0
					},
					now: { // The current time
						type: Number,
						value: null
					},
					modelTimer: {
						type: Object,
						value: () => {
							return new ModelTimer();
						}
					}

				}
			};
		}

		connectedCallback() {
			super.connectedCallback();
			this.now = Date.now();
			this.set('modelTimer.now', this.now);

		}

		toggleTimer() {
			this.runningTimer = !this.runningTimer;
			this.set('modelTimer.runningTimer', this.runningTimer);
			this.broadcastAction('update-model', {
				key: 'runningTimer',
				value: this.runningTimer,
				readOnly: true
			});
			if (!this.runningTimer) {
				this.totalTime += (Date.now() - this.now);
				this.set('modelTimer.totalTime', this.totalTime);
				this.broadcastAction('update-model', {
					key: 'totalTime',
					value: this.totalTime,
					readOnly: true
				});
			} else {
				this.now = Date.now();
				this.set('modelTimer.now', this.now);
				this.broadcastAction('update-model', {
					key: 'now',
					value: this.now,
					readOnly: true
				});
			}
		}

		resetTimer() {
			this.runningTimer = false;
			this.set('modelTimer.runningTimer', this.runningTimer);
			this.totalTime = 0;
			this.set('modelTimer.totalTime', this.totalTime);
			this.now = Date.now();
			this.set('modelTimer.now', this.now);
			this.broadcastAction('update-model', [
				{
					key: 'runningTimer',
					value: this.runningTimer,
					readOnly: true
					},
				{
					key: 'totalTime',
					value: this.totalTime,
					readOnly: true
					},
				{
					key: 'now',
					value: this.now,
					readOnly: true
					}
					]);
		}

	};

</script>
