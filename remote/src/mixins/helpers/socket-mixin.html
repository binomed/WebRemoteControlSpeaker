<link rel="import" href="event-bus-mixin.html">
<link rel="import" href="../../js/helpers/socket-helper.html">

<script>
	const SocketMixin = subclass => class extends EventBusMixin(subclass) {

		constructor() {
			super();
			this.socketIO = null;
			this.innerConf = {};
		}

		connectedCallback() {
			super.connectedCallback();
			this.subscribeForKey('update-model', this._confUpdate.bind(this));
		}

		sendMessage(message) {
			try {
				this.socketIO.sendMessage(message);
			} catch (e) {
				console.warn(e);
			}
		}

		_confUpdate(type, data) {
			if (data.key === 'modelConf.conf' && data.value.port) {
				this.innerConf = data.value;
				console.debug(this.innerConf);
				this._initWebSocket();
			}
		}

		_initWebSocket() {
			this.socketIO = new WebSocketHelper(`http://${window.location.hostname}:${this.innerConf.port}`, this._presentationMessage.bind(this));
		}

		_presentationMessage(json) {
			// To overide
			switch (json.type) {
				case 'config':
					if (json.url) {
						this.broadcastAction('update-model', [
							{
								key: 'modelConf.localUrl',
								value: `http://${window.location.hostname}:${this.innerConf.port}${json.url}`
							},
							{
								key: 'modelStates.nbSlides',
								value: json.nbSlides
							},
							{
								key: 'modelStates.mapPosition',
								value: json.mapPosition
							}
						]);
					} else if (json.indices) {
						this.broadcastAction('update-model', [
							{
								key: 'modelStates.indicesDist',
								value: json.indices
							},
							{
								key: 'modelStates.currentSlideNumber',
								value: json.currentSlideNumber
							}
						]);
						// TODO
						// this.currentSlideNumber = this.mapPosition[this.indicesDist.h+'-'+this.indicesDist.v];
					}
					break;
				case 'notes':
					console.log(json.data.notes);
					this.broadcastAction('update-model', {
						key: 'contentNotes',
						value: json.data.notes
					});
					break;
				case 'plugin':
					break;
			}
		}

	};

</script>
