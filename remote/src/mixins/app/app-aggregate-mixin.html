<link rel="import" href="../helpers/mixin-builder.html">
<link rel="import" href="../helpers/dispatcher-mixin.html">
<link rel="import" href="../helpers/socket-mixin.html">
<link rel="import" href="../helpers/event-bus-mixin.html">
<link rel="import" href="../models/conf-mixin.html">
<link rel="import" href="../models/conf-mixin.html">
<link rel="import" href="../models/engine-mixin.html">
<link rel="import" href="../models/index-mixin.html">
<link rel="import" href="../models/notes-mixin.html">
<link rel="import" href="../models/plugins-mixin.html">
<link rel="import" href="../models/timer-mixin.html">

<script>
	const AppAgregateMixin = subclass => class extends mix(subclass)
		.with(DispatcherMixin,
			EventBusMixin,
			SocketMixin,
			EngineMixin,
			ConfModelMixin,
			IndexModelMixin,
			NotesModelMixin,
			PluginsModelMixin,
			TimerModelMixin) {

			static get config() {
				// properties, observers meta data
				return {
					properties: {}
				};
			}

			constructor() {
				super();
				this.subscribeForKey('update-model', this._modelUpdate.bind(this));
				this.subscribeForKey([
				'toggle-drawer',
				'expand-notes',
				'scan-qr-code-finish'
				], this._dispatchUiAction.bind(this));
				this.subscribeForKey([
				'update-time',
				'start-stop-timer',
				'update-interval',
				'reset-timer',
				'reset-index',
				'control-press',
				'change-slides',
				'register-plugin',
				'activ-plugin',
				'desactiv-plugin',
				'plugin-communication'
				], this._computeActions.bind(this));
			}

			connectedCallback() {
				super.connectedCallback();
			}

			_computeActions(type, data) {
				switch (type) {
					case 'update-time':
						this.totalTime = data.totalTime;
						this.set('modelTimer.totalTime', this.totalTime);
						break;
					case 'start-stop-timer':
						this.toggleTimer();
						break;
					case 'reset-timer':
						this.resetTimer();
						break;
					case 'reset-index':
						this.engine.first();
						break;
					case 'update-interval':
						this.defaultInterval = data.interval;
						this.set('modelTimer.defaultInterval', this.defaultInterval);
						break;
					case 'control-press':
						this.sendMessage({
							type: 'operation',
							data: 'show',
							index: this.indices
						});
						break;
					case 'change-slides':
						this.indices = data.indices;
						this.nextSlideNumber = this.mapPosition[this.indices.h + '-' + this.indices.v];
						break;
					case 'register-plugin':
						this.registerPlugin(data);
						break;
					case 'activ-plugin':
						this.activPlugin = data;
						this._dispatchUiAction(type, data);
						break;
					case 'desactiv-plugin':
						const oldActivPlugin = Object.assign({}, this.activPlugin);
						this.activPlugin = null;
						this._dispatchUiAction(type, oldActivPlugin);
						break;
					case 'plugin-communication':
						this.sendMessage({
							type: 'communicate-plugin',
							id: data.plugin,
							data: data.data,
						});
						break;
				}
			}

			_modelUpdate(type, data) {
				if (!data.readOnly) {
					this.set(data.key, data.value);
				}
			}

			_dispatchUiAction(type, data) {

			}

		};

</script>
